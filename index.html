<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>RockhoundGeoMaps â€¢ Field PWA</title>
  <meta name="theme-color" content="#111827"/>
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #map{position:fixed;inset:0}
    .panel{position:fixed;top:10px;left:10px;z-index:5;background:#111827cc;color:#fff;
      border-radius:12px;padding:10px;backdrop-filter:blur(6px);max-width:92vw}
    .panel h1{margin:0 0 6px;font-size:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0}
    button,label,select,input[type="file"]{background:#1f2937;color:#fff;border:1px solid #374151;
      border-radius:10px;padding:8px 10px;font-size:14px}
    button:hover{background:#374151;cursor:pointer}
    .pill{padding:6px 10px;border-radius:999px;font-size:13px}
    .marker{width:14px;height:14px;border:2px solid #fff;border-radius:50%;background:#ef4444;
      box-shadow:0 1px 6px rgba(0,0,0,.35)}
    .popup{max-width:240px}
    .popup img{max-width:100%;border-radius:8px;margin-top:6px}
    .toast{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);background:#111827cc;color:#fff;
      padding:8px 12px;border-radius:10px;z-index:6;display:none}
    .attribution{position:fixed;right:10px;bottom:10px;z-index:4;font-size:11px;background:#111827cc;
      color:#e5e7eb;padding:6px 8px;border-radius:8px}
    a,a:visited{color:#93c5fd}
    #importFile{display:none}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h1>RockhoundGeoMaps</h1>
    <div class="row">
      <button id="locBtn">ğŸ“ Follow Me</button>
      <button id="addBtn" title="Tap map to drop pins">ğŸª¨ Add Pin</button>
      <button id="baseBtn">ğŸ—ºï¸ Base: Streets</button>
      <button id="toggleTopo">ğŸ—ºï¸ USGS Topo: OFF</button>
      <button id="toggleFEMA">ğŸŒŠ FEMA Flood: OFF</button>
      <button id="toggleBLM">ğŸï¸ BLM Public Lands: OFF</button>
    </div>
    <div class="row">
      <button id="exportBtn">ğŸ’¾ Export</button>
      <label class="pill" for="importFile">ğŸ“¥ Import</label>
      <input type="file" id="importFile" accept=".json"/>
      <button id="aiBtn" title="Placeholder â€“ wire to AI later">ğŸ¤– ID Rock (beta)</button>
      <button id="proBtn" title="Upgrade to Pro features">ğŸ’ Go Pro</button>
    </div>
    <div class="row" style="font-size:12px;opacity:.85">
      Tip: Tap <b>Add Pin</b>, then click the map. Pins save to this device (offline-friendly). Export for backup.
    </div>
  </div>

  <div class="attribution">
    Streets Â© OpenStreetMap â€¢ Satellite Â© Esri â€¢ Topo Â© USGS â€¢ Flood Â© FEMA â€¢ Public lands Â© BLM
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ---------- Toast helper ----------
    const toast = (msg)=>{const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';
      setTimeout(()=>t.style.display='none',2000)};

    // ---------- Map init ----------
    const styleObj = {
      version: 8,
      sources: {
        streets: {
          type: "raster",
          tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
          tileSize: 256,
          attribution: "Â© OpenStreetMap"
        },
        satellite: {
          type: "raster",
          tiles: ["https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"],
          tileSize: 256,
          attribution: "Esri World Imagery"
        }
      },
      layers: [
        { id: "streets", type: "raster", source: "streets", layout: { visibility: "visible" } },
        { id: "satellite", type: "raster", source: "satellite", layout: { visibility: "none" } }
      ]
    };

    const map = new maplibregl.Map({
      container: 'map',
      style: styleObj,
      center: [-101.7, 43.5],
      zoom: 6.5,
      minZoom: 2,
      maxZoom: 19,     // <- higher ceiling so you can zoom way in
      hash: true       // <- URL remembers viewpoint
    });

    map.on('error', e => console.warn('Map error:', e));

    // Basic controls
    map.addControl(new maplibregl.NavigationControl(), 'bottom-right');
    const geolocate = new maplibregl.GeolocateControl({
      positionOptions: { enableHighAccuracy: true },
      trackUserLocation: true, showUserHeading: true
    });
    map.addControl(geolocate, 'bottom-right');

    // ---------- Local storage for pins ----------
    const LS_KEY='rghm_pins_v1';
    const loadPins=()=>{try{return JSON.parse(localStorage.getItem(LS_KEY)||'[]')}catch{return[]}};
    const savePins=(arr)=>localStorage.setItem(LS_KEY,JSON.stringify(arr));
    let pins=loadPins();
    let addMode=false;

    // ---------- Overlays ----------
    // (Added after map load so errors donâ€™t block the page)
    const OVERLAYS = {
      topo: { id:'usgs-topo', layer:'usgs-topo-layer',
              url:'https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}' },
      fema: { id:'fema-nfhl', layer:'fema-nfhl-layer',
              url:'https://hazards.fema.gov/gis/nfhl/rest/services/public/NFHL/MapServer/tile/{z}/{y}/{x}' },
      blm:  { id:'blm-sma', layer:'blm-sma-layer',
              url:'https://gis.blm.gov/arcgis/rest/services/lands/BLM_Natl_SMA/MapServer/tile/{z}/{y}/{x}' }
    };
    const vis={topo:false,fema:false,blm:false};

    map.on('load', ()=>{
      // Add overlays
      Object.values(OVERLAYS).forEach(s=>{
        try{
          map.addSource(s.id,{type:'raster',tiles:[s.url],tileSize:256});
          map.addLayer({id:s.layer,type:'raster',source:s.id,layout:{visibility:'none'}});
        }catch(err){ console.warn('Overlay load failed',s.id,err); }
      });
      // Draw existing pins
      pins.forEach(addMarkerToMap);
    });

    // ---------- Markers / pins ----------
    const markers=new Map();
    const newId=()=>Math.random().toString(36).slice(2,9);

    function addMarkerToMap(p){
      const el=document.createElement('div'); el.className='marker';
      const m=new maplibregl.Marker({element:el})
        .setLngLat([p.lng,p.lat])
        .setPopup(makePopup(p))
        .addTo(map);
      markers.set(p.id,m);
    }

    function makePopup(p){
      const d=document.createElement('div'); d.className='popup';
      d.innerHTML=`
        <b>${p.title||'Rock/Fossil Pin'}</b><br/>
        <small>${new Date(p.ts).toLocaleString()}</small><br/>
        ${p.note?`<div>${p.note}</div>`:''}
        ${p.photo?`<img src="${p.photo}" alt="pin photo">`:''}
        <div style="margin-top:8px;display:flex;gap:6px">
          <button id="edit-${p.id}">Edit</button>
          <button id="del-${p.id}">Delete</button>
        </div>`;
      setTimeout(()=>{
        const del=document.getElementById(`del-${p.id}`);
        const edt=document.getElementById(`edit-${p.id}`);
        if(del) del.onclick=()=>{
          pins=pins.filter(x=>x.id!==p.id); savePins(pins);
          markers.get(p.id)?.remove(); markers.delete(p.id); toast('Pin deleted');
        };
        if(edt) edt.onclick=()=>editPin(p.id);
      },0);
      return new maplibregl.Popup({offset:16}).setDOMContent(d);
    }

    async function promptForPinMeta(existing={}){
      const title=prompt('Title:', existing.title||'Find');
      if(title===null) return null;
      const note=prompt('Notes:', existing.note||'');
      let photoData=existing.photo||'';
      try{
        const file=await new Promise(res=>{
          const input=document.createElement('input');
          input.type='file'; input.accept='image/*';
          input.onchange=()=>res(input.files[0]||null); input.click();
        });
        if(file){
          const rd=new FileReader();
          rd.onload=()=>photoData=rd.result; rd.readAsDataURL(file);
          await new Promise(r=>rd.onloadend=r);
        }
      }catch(_){}
      return {title,note,photo:photoData};
    }

    async function editPin(id){
      const i=pins.findIndex(p=>p.id===id); if(i===-1) return;
      const meta=await promptForPinMeta(pins[i]); if(!meta) return;
      Object.assign(pins[i],meta); savePins(pins);
      markers.get(id)?.setPopup(makePopup(pins[i])); toast('Pin updated');
    }

    // ---------- UI bindings ----------
    document.getElementById('locBtn').onclick=()=>geolocate.trigger();

    document.getElementById('addBtn').onclick=()=>{
      addMode=!addMode;
      document.getElementById('addBtn').textContent=addMode?'âœ… Tap Map':'ğŸª¨ Add Pin';
      toast(addMode?'Tap the map to place a pin':'Add mode off');
    };

    // base layer toggle (streets <-> satellite)
    let baseIsSatellite=false;
    document.getElementById('baseBtn').onclick=()=>{
      baseIsSatellite=!baseIsSatellite;
      map.setLayoutProperty('streets','visibility', baseIsSatellite?'none':'visible');
      map.setLayoutProperty('satellite','visibility', baseIsSatellite?'visible':'none');
      document.getElementById('baseBtn').textContent = baseIsSatellite ? 'ğŸ—ºï¸ Base: Satellite' : 'ğŸ—ºï¸ Base: Streets';
    };

    // overlay toggles
    const bindToggle=(key,btnId,label)=>{
      document.getElementById(btnId).onclick=()=>{
        vis[key]=!vis[key];
        map.setLayoutProperty(OVERLAYS[key].layer,'visibility', vis[key]?'visible':'none');
        document.getElementById(btnId).textContent = `${label}: ${vis[key]?'ON':'OFF'}`;
      };
    };
    bindToggle('topo','toggleTopo','ğŸ—ºï¸ USGS Topo');
    bindToggle('fema','toggleFEMA','ğŸŒŠ FEMA Flood');
    bindToggle('blm','toggleBLM','ğŸï¸ BLM Public Lands');

    // click to add a pin when in addMode
    map.on('click', async (e)=>{
      if(!addMode) return;
      const meta=await promptForPinMeta(); if(!meta) return;
      const p={id:newId(),lat:e.lngLat.lat,lng:e.lngLat.lng,ts:Date.now(),...meta};
      pins.push(p); savePins(p); addMarkerToMap(p);
      addMode=false; document.getElementById('addBtn').textContent='ğŸª¨ Add Pin';
      toast('Pin added');
    });

    // export / import
    document.getElementById('exportBtn').onclick=()=>{
      const blob=new Blob([JSON.stringify(pins,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='rockhoundgeomaps_pins.json'; a.click();
      URL.revokeObjectURL(url);
    };

    document.getElementById('importFile').onchange=(e)=>{
      const file=e.target.files[0]; if(!file) return;
      const rd=new FileReader();
      rd.onload=()=>{
        try{
          const data=JSON.parse(rd.result);
          if(!Array.isArray(data)) throw new Error('Invalid JSON');
          // clear existing markers
          markers.forEach(m=>m.remove()); markers.clear();
          pins=data; savePins(pins); pins.forEach(addMarkerToMap);
          toast('Imported pins');
        }catch(err){ toast('Import failed'); }
      };
      rd.readAsText(file);
    };

    // misc buttons
    document.getElementById('aiBtn').onclick=()=>toast('AI Rock ID is coming soon!');
    document.getElementById('proBtn').onclick=()=>window.open('https://www.paypal.com/ncp/payment/4ELF9X644EQZ6','_blank');
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RockhoundGeoMaps ‚Ä¢ Field PWA</title>
  <meta name="theme-color" content="#111827" />
  <style>
    html, body {height:100%; margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    #map {position:fixed; inset:0;}
    .panel {
      position:fixed; top:10px; left:10px; z-index:5; background:#111827cc; color:#fff;
      border-radius:12px; padding:10px; backdrop-filter: blur(6px); max-width: 92vw;
    }
    .panel h1 {margin:0 0 6px; font-size:16px;}
    .row {display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:6px 0;}
    button, label, select, input[type="file"] {
      background:#1f2937; color:#fff; border:1px solid #374151; border-radius:10px; padding:8px 10px; font-size:14px;
    }
    button:hover {background:#374151; cursor:pointer;}
    .pill {padding:6px 10px; border-radius:999px; font-size:13px;}
    .marker {
      width:14px; height:14px; border:2px solid #fff; border-radius:50%;
      background:#ef4444; box-shadow:0 1px 6px rgba(0,0,0,.35);
    }
    .popup {max-width:240px;}
    .popup img {max-width:100%; border-radius:8px; margin-top:6px;}
    .toast {
      position:fixed; bottom:12px; left:50%; transform:translateX(-50%); background:#111827cc; color:#fff;
      padding:8px 12px; border-radius:10px; z-index:6; display:none;
    }
  </style>
  <!-- MapLibre GL (no key needed) -->
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h1>RockhoundGeoMaps</h1>
    <div class="row">
      <button id="locBtn">üìç Follow Me</button>
      <button id="addBtn" title="Tap map to drop pins">ü™® Add Pin</button>
      <button id="toggleTopo">üó∫Ô∏è USGS Topo: OFF</button>
      <button id="exportBtn">üíæ Export</button>
      <label class="pill">üì• Import <input type="file" id="importFile" accept=".json" style="display:none;"></label>
      <button id="aiBtn" title="Placeholder ‚Äì wire to AI later">ü§ñ ID Rock (beta)</button>
    </div>
    <div class="row" style="font-size:12px; opacity:.85;">
      Tip: Tap <b>Add Pin</b>, then click the map. Pins save automatically on your device.
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ---------- Utilities ----------
    const showToast = (msg) => {
      const t = document.getElementById('toast');
      t.textContent = msg; t.style.display = 'block';
      setTimeout(()=> t.style.display = 'none', 1800);
    };

    // ---------- Map init ----------
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://demotiles.maplibre.org/style.json', // free style
      center: [-101.7, 43.5], // start near Buffalo Gap / Ogallala
      zoom: 7
    });

    map.addControl(new maplibregl.NavigationControl(), 'bottom-right');

    // geolocate control (follows user)
    const geolocate = new maplibregl.GeolocateControl({
      positionOptions: { enableHighAccuracy: true },
      trackUserLocation: true, showUserHeading: true
    });
    map.addControl(geolocate, 'bottom-right');

    // ---------- Local storage for pins ----------
    const LS_KEY = 'rghm_pins_v1';

    const loadPins = () => {
      try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }
      catch { return []; }
    };
    const savePins = (arr) => localStorage.setItem(LS_KEY, JSON.stringify(arr));

    let pins = loadPins();
    let addMode = false;
    const markers = new Map(); // id -> marker

    // ---------- USGS Topo raster layer ----------
    // Note: public tiled service; added as raster source
    const TOPO_SOURCE = 'usgs-topo';
    const TOPO_LAYER  = 'usgs-topo-layer';
    let topoVisible = false;

    map.on('load', () => {
      map.addSource(TOPO_SOURCE, {
        type: 'raster',
        tiles: [
          'https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}'
        ],
        tileSize: 256,
        attribution: 'USGS'
      });
      map.addLayer({ id: TOPO_LAYER, type: 'raster', source: TOPO_SOURCE, layout: { visibility: 'none' } });

      // render any stored pins
      pins.forEach(addMarkerToMap);
    });

    // ---------- Marker helpers ----------
    function addMarkerToMap(p) {
      const el = document.createElement('div'); el.className = 'marker';
      const m = new maplibregl.Marker({ element: el, draggable: false })
        .setLngLat([p.lng, p.lat])
        .setPopup(makePopup(p))
        .addTo(map);
      markers.set(p.id, m);
    }

    function makePopup(p) {
      const d = document.createElement('div');
      d.className = 'popup';
      d.innerHTML = `
        <b>${p.title || 'Rock/Fossil Pin'}</b><br/>
        <small>${new Date(p.ts).toLocaleString()}</small><br/>
        ${p.note ? `<div>${p.note}</div>` : ''}
        ${p.photo ? `<img src="${p.photo}" alt="pin photo"/>` : ''}
        <div style="margin-top:8px; display:flex; gap:6px;">
          <button id="edit-${p.id}">Edit</button>
          <button id="del-${p.id}">Delete</button>
        </div>
      `;
      setTimeout(() => {
        document.getElementById(`del-${p.id}`).onclick = () => {
          const idx = pins.findIndex(x => x.id === p.id);
          if (idx !== -1) { pins.splice(idx,1); savePins(pins); }
          markers.get(p.id)?.remove(); markers.delete(p.id);
          showToast('Pin deleted');
        };
        document.getElementById(`edit-${p.id}`).onclick = () => editPin(p.id);
      }, 0);
      return new maplibregl.Popup({ offset: 16 }).setDOMContent(d);
    }

    function newId(){ return Math.random().toString(36).slice(2,9); }

    async function promptForPinMeta(existing={}) {
      const title = prompt('Title:', existing.title || 'Find');
      if (title === null) return null;
      const note = prompt('Notes:', existing.note || '');
      let photoData = existing.photo || '';

      // optional photo: allow paste from clipboard (mobile browsers allow camera)
      try {
        const file = await new Promise((res) => {
          const input = document.createElement('input');
          input.type = 'file'; input.accept = 'image/*';
          input.onchange = () => res(input.files[0] || null);
          input.click();
        });
        if (file) {
          const b64 = await fileToDataURL(file);
          photoData = b64;
        }
      } catch(_) {}

      return { title, note, photo: photoData };
    }

    function fileToDataURL(file){
      return new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = rej;
        r.readAsDataURL(file);
      });
    }

    async function editPin(id) {
      const i = pins.findIndex(p => p.id === id);
      if (i === -1) return;
      const meta = await promptForPinMeta(pins[i]);
      if (!meta) return;
      Object.assign(pins[i], meta);
      savePins(pins);
      markers.get(id)?.setPopup(makePopup(pins[i]));
      showToast('Pin updated');
    }

    // ---------- UI actions ----------
    document.getElementById('toggleTopo').onclick = () => {
      topoVisible = !topoVisible;
      map.setLayoutProperty(TOPO_LAYER, 'visibility', topoVisible ? 'visible' : 'none');
      document.getElementById('toggleTopo').textContent = `üó∫Ô∏è USGS Topo: ${topoVisible ? 'ON' : 'OFF'}`;
    };

    document.getElementById('locBtn').onclick = () => {
      geolocate.trigger();
    };

    document.getElementById('addBtn').onclick = () => {
      addMode = !addMode;
      document.getElementById('addBtn').textContent = addMode ? '‚úÖ Tap Map' : 'ü™® Add Pin';
      showToast(addMode ? 'Tap the map to place a pin' : 'Add mode off');
    };

    map.on('click', async (e) => {
      if (!addMode) return;
      const meta = await promptForPinMeta();
      if (!meta) return;
      const p = { id: newId(), lat: e.lngLat.lat, lng: e.lngLat.lng, ts: Date.now(), ...meta };
      pins.push(p); savePins(pins); addMarkerToMap(p);
      addMode = false; document.getElementById('addBtn').textContent = 'ü™® Add Pin';
      showToast('Pin added');
    });

    document.getElementById('exportBtn').onclick = () => {
      const blob = new Blob([JSON.stringify(pins, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'rockhoundgeomaps_pins.json'; a.click();
      URL.revokeObjectURL(url);
    };

    document.querySelector('label[for="importFile"]')?.addEventListener?.('click', () => {
      document.getElementById('importFile').click();
    });
    document.getElementById('importFile').onchange = (e) => {
      const f = e.target.files[0]; if (!f) return;
      const r = new FileReader();
      r.onload = () => {
        try {
          const arr = JSON.parse(r.result);
          if (!Array.isArray(arr)) throw new Error('Invalid file');
          // clear existing
          markers.forEach(m => m.remove()); markers.clear();
          pins = arr; savePins(pins); pins.forEach(addMarkerToMap);
          showToast('Imported pins');
        } catch { showToast('Import failed'); }
      };
      r.readAsText(f);
    };

    document.getElementById('aiBtn').onclick = () => {
      alert('AI Rock ID placeholder.\nLater: send photo to your chosen AI API and show result here.');
    };
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RockhoundGeoMaps ‚Ä¢ Field PWA</title>
  <meta name="theme-color" content="#111827" />
  <style>
    html, body {height:100%; margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    #map {position:fixed; inset:0;}
    .panel {position:fixed; top:10px; left:10px; z-index:5; background:#111827cc; color:#fff;
      border-radius:12px; padding:10px; backdrop-filter: blur(6px); max-width: 92vw;}
    .panel h1 {margin:0 0 6px; font-size:16px;}
    .row {display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:6px 0;}
    button, label, select, input[type="file"] {background:#1f2937; color:#fff; border:1px solid #374151;
      border-radius:10px; padding:8px 10px; font-size:14px;}
    button:hover {background:#374151; cursor:pointer;}
    .pill {padding:6px 10px; border-radius:999px; font-size:13px;}
    .marker { width:14px; height:14px; border:2px solid #fff; border-radius:50%; background:#ef4444; box-shadow:0 1px 6px rgba(0,0,0,.35); }
    .popup {max-width:240px;}
    .popup img {max-width:100%; border-radius:8px; margin-top:6px;}
    .toast {position:fixed; bottom:12px; left:50%; transform:translateX(-50%); background:#111827cc; color:#fff;
      padding:8px 12px; border-radius:10px; z-index:6; display:none;}
    .attribution {position:fixed; right:10px; bottom:10px; z-index:4; font-size:11px; background:#111827cc; color:#e5e7eb; padding:6px 8px; border-radius:8px;}
    a, a:visited {color:#93c5fd;}
    #importFile{display:none;}
  </style>
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h1>RockhoundGeoMaps</h1>
    <div class="row">
      <button id="locBtn">üìç Follow Me</button>
      <button id="addBtn" title="Tap map to drop pins">ü™® Add Pin</button>
      <button id="toggleTopo">üó∫Ô∏è USGS Topo: OFF</button>
      <button id="toggleFEMA">üåä FEMA Flood: OFF</button>
      <button id="toggleBLM">üèûÔ∏è BLM Public Lands: OFF</button>
    </div>
    <div class="row">
      <button id="exportBtn">üíæ Export</button>
      <label class="pill" for="importFile">üì• Import</label>
      <input type="file" id="importFile" accept=".json" />
      <button id="aiBtn" title="Placeholder ‚Äì wire to AI later">ü§ñ ID Rock (beta)</button>
      <button id="proBtn" title="Upgrade to Pro features">üíé Go Pro</button>
    </div>
    <div class="row" style="font-size:12px; opacity:.85;">
      Tip: Tap <b>Add Pin</b>, then click the map. Pins save to this device (offline-friendly). Export for backup.
    </div>
  </div>

  <div class="attribution">
    Basemaps ¬© <a href="https://www.usgs.gov/" target="_blank">USGS</a> ‚Ä¢
    Flood data ¬© <a href="https://msc.fema.gov/" target="_blank">FEMA</a> ‚Ä¢
    Public lands ¬© <a href="https://www.blm.gov/" target="_blank">BLM</a>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ---------- Utilities ----------
    const toast = (msg) => {
      const t = document.getElementById('toast');
      t.textContent = msg; t.style.display = 'block';
      setTimeout(()=> t.style.display = 'none', 2000);
    };

    // ---------- Map init ----------
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {
          osm: {
            type: "raster",
            tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
            tileSize: 256,
            attribution: "¬© OpenStreetMap"
          }
        },
        layers: [{
          id: "osm",
          type: "raster",
          source: "osm"
        }]
      },
      center: [-101.7, 43.5],
      zoom: 7
    });

    map.on('error', (e) => {
      const msg = (e && e.error && e.error.message) ? e.error.message : 'Map error';
      toast(msg);
      console.error('Map error:', e);
    });

    map.addControl(new maplibregl.NavigationControl(), 'bottom-right');

    const geolocate = new maplibregl.GeolocateControl({
      positionOptions: { enableHighAccuracy: true },
      trackUserLocation: true, showUserHeading: true
    });
    map.addControl(geolocate, 'bottom-right');

    // ---------- Local storage for pins ----------
    const LS_KEY = 'rghm_pins_v1';
    const loadPins = () => { try { return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); } catch { return []; } };
    const savePins = (arr) => localStorage.setItem(LS_KEY, JSON.stringify(arr));
    let pins = loadPins();
    let addMode = false;

    // ---------- Pro unlock basics ----------
    const PRO_CODE = 'RHGM-2025-PRO';
    const BUY_URL  = 'https://www.paypal.com/ncp/payment/4ELF9X644EQZ6';
    let isPro = localStorage.getItem('rghm_pro') === '1';

    // ---------- Raster overlays ----------
    const SOURCES = {
      topo: {
        id: 'usgs-topo',
        url: 'https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}',
        layerId: 'usgs-topo-layer',
        labelBtn: 'toggleTopo'
      },
      fema: {
        id: 'fema-nfhl',
        url: 'https://hazards.fema.gov/gis/nfhl/rest/services/public/NFHL/MapServer/tile/{z}/{y}/{x}',
        layerId: 'fema-nfhl-layer',
        labelBtn: 'toggleFEMA'
      },
      blm: {
        id: 'blm-sma',
        url: 'https://gis.blm.gov/arcgis/rest/services/lands/BLM_Natl_SMA/MapServer/tile/{z}/{y}/{x}',
        layerId: 'blm-sma-layer',
        labelBtn: 'toggleBLM'
      }
    };
    const visibility = { topo:false, fema:false, blm:false };

    map.on('load', () => {
      for (const key of Object.keys(SOURCES)) {
        const s = SOURCES[key];
        try {
          map.addSource(s.id, {
            type: 'raster',
            tiles: [s.url],
            tileSize: 256,
            attribution: key === 'topo' ? 'USGS' : key === 'fema' ? 'FEMA' : 'BLM'
          });
          map.addLayer({ id: s.layerId, type: 'raster', source: s.id, layout: { visibility: 'none' } });
        } catch (e) {
          console.warn('Layer add failed', key, e);
          toast(`Couldn‚Äôt load ${key.toUpperCase()} layer`);
        }
      }
      pins.forEach(addMarkerToMap);
    });

    // ---------- Marker logic ----------
    const markers = new Map();

    function newId() {
      return Math.random().toString(36).slice(2, 9);
    }

    function addMarkerToMap(p) {
      const el = document.createElement('div'); el.className = 'marker';
      const m = new maplibregl.Marker({ element: el })
        .setLngLat([p.lng, p.lat])
        .setPopup(makePopup(p))
        .addTo(map);
      markers.set(p.id, m);
    }

    function makePopup(p) {
      const d = document.createElement('div');
      d.className = 'popup';
      d.innerHTML = `
        <b>${p.title || 'Rock/Fossil Pin'}</b><br/>
        <small>${new Date(p.ts).toLocaleString()}</small><br/>
        ${p.note ? `<div>${p.note}</div>` : ''}
        ${p.photo ? `<img src="${p.photo}" alt="pin photo"/>` : ''}
        <div style="margin-top:8px; display:flex; gap:6px;">
          <button id="edit-${p.id}">Edit</button>
          <button id="del-${p.id}">Delete</button>
        </div>`;
      setTimeout(() => {
        document.getElementById(`del-${p.id}`).onclick = () => {
          pins = pins.filter(x => x.id !== p.id);
          savePins(pins);
          markers.get(p.id)?.remove();
          markers.delete(p.id);
          toast('Pin deleted');
        };
        document.getElementById(`edit-${p.id}`).onclick = () => editPin(p.id);
      }, 0);
      return new maplibregl.Popup({ offset: 16 }).setDOMContent(d);
    }

    async function promptForPinMeta(existing = {}) {
      const title = prompt('Title:', existing.title || 'Find');
      if (title === null) return null;
      const note = prompt('Notes:', existing.note || '');
      let photoData = existing.photo || '';
      try {
        const file = await new Promise((res) => {
          const input = document.createElement('input');
          input.type = 'file'; input.accept = 'image/*';
          input.onchange = () => res(input.files[0] || null);
          input.click();
        });
        if (file) {
          const reader = new FileReader();
          reader.onload = () => photoData = reader.result;
          reader.readAsDataURL(file);
          await new Promise(r => reader.onloadend = r);
        }
      } catch (_) {}
      return { title, note, photo: photoData };
    }

    async function editPin(id) {
      const idx = pins.findIndex(p => p.id === id);
      if (idx === -1) return;
      const meta = await promptForPinMeta(pins[idx]);
      if (!meta) return;
      Object.assign(pins[idx], meta);
      savePins(pins);
      markers.get(id)?.setPopup(makePopup(pins[idx]));
      toast('Pin updated');
    }

    // ---------- UI Bindings ----------
    const bindToggle = (key, labelId, labelText) => {
      const btn = document.getElementById(labelId);
      btn.onclick = () => {
        visibility[key] = !visibility[key];
        map.setLayoutProperty(SOURCES[key].layerId, 'visibility', visibility[key] ? 'visible' : 'none');
        btn.textContent = `${labelText}: ${visibility[key] ? 'ON' : 'OFF'}`;
      };
    };
    bindToggle('topo', 'toggleTopo', 'üó∫Ô∏è USGS Topo');
    bindToggle('fema', 'toggleFEMA','üåä FEMA Flood');
    bindToggle('blm',  'toggleBLM', 'üèûÔ∏è BLM Public Lands');

    document.getElementById('locBtn').onclick = () => geolocate.trigger();

    document.getElementById('addBtn').onclick = () => {
      addMode = !addMode;
      document.getElementById('addBtn').textContent = addMode ? '‚úÖ Tap Map' : 'ü™® Add Pin';
      toast(addMode ? 'Tap the map to place a pin' : 'Add mode off');
    };

    map.on('click', async (e) => {
      if (!addMode) return;
      const meta = await promptForPinMeta();
      if (!meta) return;
      const p = { id: newId(), lat: e.lngLat.lat, lng: e.lngLat.lng, ts: Date.now(), ...meta };
      pins.push(p); savePins(pins); addMarkerToMap(p);
      addMode = false; document.getElementById('addBtn').textContent = 'ü™® Add Pin';
      toast('Pin added');
    });

    document.getElementById('exportBtn').onclick = () => {
      const blob = new Blob([JSON.stringify(pins, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'rockhoundgeomaps_pins.json'; a.click();
      URL.revokeObjectURL(url);
    };

    document.getElementById('importFile').onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (!Array.isArray(data)) throw new Error('Invalid JSON structure');
          markers.forEach(m => m.remove());
          markers.clear();
          pins = data;
          savePins(pins);
          pins.forEach(addMarkerToMap);
          toast('Imported pins');
        } catch (err) {
          toast('Import failed');
        }
      };
      reader.readAsText(file);
    };

    document.getElementById('aiBtn').onclick = () => {
      toast('AI Rock ID is coming soon!');
    };

    document.getElementById('proBtn').onclick = () => {
      window.open(BUY_URL, '_blank');
    };
  </script>
</body>
</html>
